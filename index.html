<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patch Code Batch Scanning Sample</title>
    <script src="https://unpkg.com/dwt@18.0.0/dist/dynamsoft.webtwain.min.js"></script>
    <style>
      #options {
        border: 1px solid black;
        border-radius: 5px;
        width: 350px;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <h2 class="title">Batch Document Scanning with Patch Code</h2>
      <button onclick="scan();">Scan</button>
      <button onclick="loadFile();">Load File</button>
      <button onclick="save();">Save</button>
      <span id="status"></span>
      <div>
        <div id="options">
          <div>Options:</div>
          <label for="enableSeparation">
            Enable document separation with Patch Code
            <input type="checkbox" id="enableSeparation"/>
          </label>
          <label for="removePatchCodePage">
            Remove the Patch Code page
            <input type="checkbox" id="removePatchCodePage"/>
          </label>
          <br/>
          <label for="removePageAfterPatchCodePage">
            Remove the next page of the Patch Code page
            <input type="checkbox" id="removePageAfterPatchCodePage"/>
          </label>
          <br/>
          <label for="outputPath">
            Output path (you need to input a base filename):
            <input type="text" id="outputPath"/>
          </label><button onclick="selectOutputPath();">Select</button>
        </div>
      </div>
      <div id="dwtcontrolContainer"></div>
    </div>
    <script>
      let DWObject;
      window.onload = function(){
        Dynamsoft.DWT.AutoLoad = false;
        Dynamsoft.DWT.ResourcesPath = "https://unpkg.com/dwt@18.0.0/dist";
        init();
      }

      function init(){
        const status = document.getElementById("status");
        Dynamsoft.DWT.Containers = [{ ContainerId: 'dwtcontrolContainer',Width: 270, Height: 350 }];
        Dynamsoft.DWT.RegisterEvent('OnWebTwainReady', function () {
          console.log("ready");
          DWObject = Dynamsoft.DWT.GetWebTwain('dwtcontrolContainer');
          DWObject.SetViewMode(2,2);
          usePatchCodeRuntimeSettings();
          status.innerText = "";
        });
        status.innerText = "Loading...";
        Dynamsoft.DWT.Load();
      }

      function scan() {
        if (DWObject) {
          DWObject.SelectSource(function () {
            DWObject.OpenSource();
            DWObject.AcquireImage();
          },
            function () {
              console.log("SelectSource failed!");
            }
          );
        }
      }

      function loadFile() {
        if (DWObject) {
          function OnSuccess() {
            console.log('successful');
          }
          function OnFailure(errorCode, errorString) {
            alert(errorString);
          }
          DWObject.IfShowFileDialog = true;
          // PDF Rasterizer Addon is used here to ensure PDF support
          DWObject.Addon.PDF.SetResolution(200);
          DWObject.Addon.PDF.SetConvertMode(Dynamsoft.DWT.EnumDWT_ConvertMode.CM_RENDERALL);
          DWObject.LoadImageEx("", Dynamsoft.DWT.EnumDWT_ImageType.IT_ALL, OnSuccess, OnFailure);
        }
      }

      async function save(){
        await tagImagesWithBarcodeReader();
      }

      async function usePatchCodeRuntimeSettings(){
        let settings = await DWObject.Addon.BarcodeReader.getRuntimeSettings();
        settings.barcodeFormatIds = Dynamsoft.DBR.EnumBarcodeFormat.BF_PATCHCODE;
        await DWObject.Addon.BarcodeReader.updateRuntimeSettings(settings);
      }

      async function tagImagesWithBarcodeReader(){
        for (let i = 0; i < DWObject.HowManyImagesInBuffer; i++) {
          let tagList =  DWObject.GetTagListByIndex(i);
          let processed = false;
          for (let j = 0; j < tagList.length; j++) {
            const tag = tagList[j];
            if (tag === "NoPatchCode" || tag === "HasPatchCode") {
              processed = true;
            }
          }
          if (processed === false) {
            let results = await DWObject.Addon.BarcodeReader.decode(i);
            if (results.length > 0) {
              DWObject.TagImages([i], "HasPatchCode");
            }else{
              DWObject.TagImages([i], "NoPatchCode");
            }
          }
        }
      }

      function selectOutputPath(){
        if (DWObject) {
          DWObject.RegisterEvent("OnGetFilePath",
            function (isSave, filesCount, index, directory, fileName) {
              console.log(directory);
              console.log(fileName);
              let path = getFullPath(directory,fileName);
              document.getElementById("outputPath").value = path;
            }
          );
          DWObject.ShowFileDialog(
            true,
            "",
            0,
            "",
            "",
            false,
            false,
            0
          );
        }
      }

      function getFullPath(directory,fileName){
        if (Dynamsoft.Lib.env.bMac) {
          return directory + "/" + fileName;
        }else{
          return directory + "\\" + fileName;
        }
      }
    </script>
  </body>
</html>